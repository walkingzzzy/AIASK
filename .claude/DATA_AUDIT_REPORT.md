# 数据源和数据库综合审查报告
**审查日期**: 2026-01-28  
**审查工具**: `packages/mcp-server-compact/scripts/audit-data-sources.ts`

---

## 📋 任务1: AKShare MCP 数据源可用性测试

### ✅ 可用的数据源 (4个)

| 工具名称 | 状态 | 数据量 | 备注 |
|---------|------|--------|------|
| `get_stock_list` | ✅ 正常 | 5,475只股票 | 获取A股全市场股票列表 |
| `get_kline` | ✅ 正常 | 测试返回100条 | 获取K线数据，支持多周期 |
| `get_financials` | ✅ 正常 | 单股票财务 | 获取财务指标数据 |
| `get_dragon_tiger` | ✅ 正常 | 81条记录 | 获取龙虎榜数据 |

### ❌ 不可用的数据源 (3个)

| 工具名称 | 状态 | 错误信息 | 原因分析 |
|---------|------|---------|---------|
| `get_realtime_quotes` | ❌ 失败 | Unknown tool | **工具名称错误**，AKShare MCP中不存在此工具 |
| `get_north_fund_flow` | ❌ 失败 | Unknown tool | **工具名称错误**，AKShare MCP中不存在此工具 |
| `get_margin_data` | ❌ 失败 | 无数据 | 工具存在但返回空数据，可能是参数或日期问题 |

### 🔍 问题分析

1. **实时行情工具缺失**: `get_realtime_quotes` 不存在于 AKShare MCP 工具列表中
   - 现有的实时行情数据是通过其他方式获取的（可能是 Sina/Tencent API）
   - 需要检查 `packages/mcp-server-compact/src/adapters/` 中的实际实现

2. **北向资金工具缺失**: `get_north_fund_flow` 不存在于 AKShare MCP 工具列表中
   - 但数据库中有301条北向资金数据，说明是通过其他途径同步的
   - 需要检查实际的数据同步逻辑

3. **融资融券数据问题**: `get_margin_data` 工具存在但返回空数据
   - 可能需要调整参数格式或日期范围
   - 但数据库中已有107,484条融资融券数据，说明历史同步是成功的

---

## 📊 任务2: 数据库实际数据审查

### 数据库整体状况

| 数据表 | 记录数 | 覆盖范围 | 数据质量 | 状态 |
|--------|--------|---------|---------|------|
| **stocks** | 5,187 | 4个市场 | ⚠️ 缺少板块/行业信息 | 基础完整 |
| **kline_1d** | 1,284,696 | 5,182只股票 | ✅ 2024-11-06 至 2026-01-26 | 优秀 |
| **financials** | 5,187 | 5,187只股票 | ⚠️ 营收/净利为0 | 需检查 |
| **stock_quotes** | 5,178 | 5,178只股票 | ✅ 2026-01-28最新 | 优秀 |
| **dragon_tiger** | 1,636 | 767只股票 | ✅ 2025-12-29 至 2026-01-27 | 良好 |
| **north_fund** | 301 | 全市场 | ✅ 2024-10-24 至 2026-01-27 | 良好 |
| **margin_data** | 107,484 | 3,589只股票 | ✅ 2012-12-14 至 2026-01-26 | 优秀 |
| **block_trades** | 0 | 无 | ❌ 完全空表 | 需同步 |

### 详细分析

#### 1. 📊 股票基础数据 (stocks)
- **总数**: 5,187只
- **市场分布**: 4个市场（SH上交所、SZ深交所、KCB科创板、BSE北交所）
- **⚠️ 问题**: 板块(sector)和行业(industry)字段全部为空
- **建议**: 需要补充股票的板块和行业分类信息

#### 2. 📈 K线数据 (kline_1d)
- **总记录**: 1,284,696条
- **覆盖股票**: 5,182只（覆盖率 99.9%）
- **时间范围**: 2024-11-06 至 2026-01-26
- **✅ 状态**: 数据完整，最新数据及时更新

#### 3. 💰 财务数据 (financials)
- **总记录**: 5,187条（每只股票1条）
- **覆盖股票**: 5,187只（覆盖率 100%）
- **报告期**: 2025-09-30 至 2025-12-31
- **⚠️ 问题**: 样本数据显示营收(revenue)和净利(net_profit)为0
  - 可能是数据结构问题，实际数据存储在其他字段
  - 需要检查 `get_financials` 返回的数据结构与数据库字段的映射关系

#### 4. 💹 实时行情 (stock_quotes)
- **总记录**: 5,178条
- **覆盖股票**: 5,178只（覆盖率 99.8%）
- **更新时间**: 2026-01-28（今日）
- **✅ 状态**: 数据实时更新，包含价格、涨跌幅等信息
- **⚠️ 注意**: PE和PB字段部分为null

#### 5. 🐉 龙虎榜数据 (dragon_tiger)
- **总记录**: 1,636条
- **涉及股票**: 767只
- **时间范围**: 2025-12-29 至 2026-01-27
- **✅ 状态**: 近期数据完整

#### 6. 🌏 北向资金 (north_fund)
- **总记录**: 301条
- **时间范围**: 2024-10-24 至 2026-01-27
- **累计净流入**: 66,659,738.13亿元（⚠️ 数值异常大，可能是单位问题）
- **✅ 状态**: 数据持续更新
- **⚠️ 问题**: 累计金额计算可能有单位换算问题

#### 7. 💳 融资融券 (margin_data)
- **总记录**: 107,484条
- **涉及股票**: 3,589只
- **时间范围**: 2012-12-14 至 2026-01-26（历史数据完整）
- **✅ 状态**: 数据量大，历史数据完整

#### 8. 📦 大宗交易 (block_trades)
- **总记录**: 0条
- **❌ 状态**: 完全空表
- **原因**: 
  - 已创建同步脚本但未成功获取数据
  - API可能需要不同的参数或日期格式
  - 或者近期确实没有大宗交易数据

---

## 🎯 核心发现

### ✅ 优势
1. **K线数据完整**: 128万+条记录，覆盖5,182只股票
2. **实时行情及时**: 今日数据已同步，覆盖5,178只股票
3. **融资融券历史完整**: 10万+条记录，跨度13年
4. **基础数据齐全**: 5,187只股票基础信息完整

### ⚠️ 需要改进
1. **股票板块/行业信息缺失**: stocks表中sector和industry字段为空
2. **财务数据映射问题**: revenue和net_profit显示为0，需检查字段映射
3. **大宗交易数据缺失**: block_trades表完全为空
4. **AKShare MCP工具名称不匹配**: 部分工具名称与实际不符

### ❌ 关键问题
1. **数据源工具不一致**: 
   - 代码中调用的工具名称（如`get_realtime_quotes`）在AKShare MCP中不存在
   - 实际数据是通过其他适配器获取的（Sina/Tencent/EastMoney）
   - 需要统一数据源调用逻辑

2. **北向资金金额异常**: 
   - 累计金额显示为6665万亿，明显不合理
   - 可能是单位换算问题（元 vs 万元 vs 亿元）

---

## 📝 建议行动

### 高优先级
1. **修复财务数据映射**: 检查`get_financials`返回数据与数据库字段的对应关系
2. **补充股票分类信息**: 为stocks表添加板块和行业信息
3. **统一数据源调用**: 明确哪些数据来自AKShare MCP，哪些来自其他适配器

### 中优先级
4. **修复北向资金单位**: 检查并修正金额单位换算逻辑
5. **解决大宗交易同步**: 调试block_trades数据获取逻辑
6. **完善PE/PB数据**: 补充stock_quotes中缺失的PE/PB值

### 低优先级
7. **优化数据更新频率**: 根据实际需求调整各类数据的更新周期
8. **添加数据质量监控**: 定期运行审查脚本，监控数据完整性

---

## 🔧 技术细节

### AKShare MCP实际可用工具
根据测试结果，以下工具在AKShare MCP中**确认可用**:
- `get_stock_list` - 获取股票列表
- `get_kline` - 获取K线数据
- `get_financials` - 获取财务数据
- `get_dragon_tiger` - 获取龙虎榜数据

### 数据来源分析
| 数据类型 | 当前来源 | AKShare MCP支持 | 备注 |
|---------|---------|----------------|------|
| 股票列表 | AKShare MCP | ✅ | get_stock_list |
| K线数据 | AKShare MCP | ✅ | get_kline |
| 财务数据 | AKShare MCP | ✅ | get_financials |
| 实时行情 | Sina/Tencent API | ❌ | 需要其他适配器 |
| 龙虎榜 | AKShare MCP | ✅ | get_dragon_tiger |
| 北向资金 | EastMoney API | ❌ | 需要其他适配器 |
| 融资融券 | EastMoney API | ⚠️ | 工具存在但返回空 |
| 大宗交易 | EastMoney API | ❌ | 未成功获取 |

---

**报告生成**: 2026-01-28  
**审查脚本**: `packages/mcp-server-compact/scripts/audit-data-sources.ts`  
**数据库**: TimescaleDB (PostgreSQL + TimescaleDB extension)
